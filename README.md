# WebSocket Audio Receiver - Версия 1.0

FastAPI-сервис для обработки аудиоданных через WebSocket с использованием разделяемой памяти для межпроцессного взаимодействия.

## Статус проекта

**Текущая версия: 1.0 (стабильная)**

Проект находится в стабильном состоянии. Основные компоненты функционируют корректно, интеграционные тесты успешно проходят.

### Реализованная функциональность

- ✅ WebSocket сервер с обработкой подключений
- ✅ Отправка и получение аудиоданных через WebSocket
- ✅ Асинхронная обработка данных в отдельных процессах
- ✅ Межпроцессное взаимодействие через разделяемую память
- ✅ Изолированные сессии для каждого клиента
- ✅ HTTP эндпоинт для проверки работоспособности сервера
- ✅ Корректная обработка команд от клиентов

### Запланированные улучшения

- ⏳ Оптимизация производительности обработки аудиоданных
- ⏳ Добавление механизма сжатия данных
- ⏳ Улучшение механизма очистки ресурсов
- ⏳ Расширение API для управления аудиопотоками

## Требования

- Python 3.8+
- Зависимости из requirements.txt
- NumPy 1.26.3 (для обработки аудиоданных)

## Установка

1. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # для Linux/Mac
venv\Scripts\activate     # для Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Запуск сервера

```bash
python -m websockets_audio_receiver.server
```

Сервер будет доступен по следующим адресам:
- WebSocket: `ws://localhost:8004/ws`
- HTTP Health Check: `http://localhost:8005/health`

## API Endpoints

### WebSocket Endpoint: `/ws`

Поддерживает следующие JSON-сообщения:

1. Запуск аудио-приёмника:
```json
{
    "command": "start_audio_receiver"
}
```
Ответ:
```json
{
    "status": "receiver_started"
}
```
или 
```json
{
    "status": "receiver_already_running"
}
```

2. Отправка аудиоданных:
Бинарные данные отправляются напрямую через WebSocket соединение.

### Health Check: `/health`

GET-запрос для проверки состояния сервера. Возвращает `200 OK` и текст "OK" при успешной работе сервера.

## Особенности реализации

- Разделяемая память для эффективной передачи данных между процессами
- Асинхронная обработка соединений с использованием asyncio
- Поддержка множественных одновременных клиентов с изолированными сессиями
- Встроенная поддержка обработки аудиоданных с использованием NumPy
- Отказоустойчивость: автоматическое восстановление после ошибок в дочерних процессах

## Технические детали

- Размер буферов: 1024 байт
- Таймаут сессии: 5 секунд
- Таймаут ожидания данных: 1 секунда
- Порт WebSocket сервера: 8004
- Порт HTTP Health Check: 8005

## Тестирование

Проект покрыт модульными, интеграционными и тестами безопасности.

### Модульные тесты

Модульные тесты проверяют отдельные компоненты системы и их взаимодействие:

- **Тесты подключения** - проверка установки и валидации WebSocket-соединений
- **Тесты команд** - проверка обработки команд от клиента (start_audio_receiver, invalid_command)
- **Тесты валидации данных** - проверка корректной обработки бинарных и текстовых данных
- **Тесты буферов** - проверка создания, использования и удаления разделяемой памяти
- **Тесты изоляции сессий** - проверка независимой работы нескольких клиентов
- **Тесты таймаутов** - проверка корректной работы при таймаутах соединений

Запуск модульных тестов:

```bash
python -m pytest tests/unit
```

Запуск конкретного модульного теста:

```bash 
python -m pytest tests/unit/test_audio_receiver.py -v
```

### Интеграционные тесты

Интеграционные тесты проверяют работу всей системы в целом:

- **Тест полного цикла данных** - проверка всей цепочки обработки от отправки до получения данных
- **Тест сценария с несколькими клиентами** - проверка одновременной работы нескольких подключений
- **Тест изоляции сессий** - проверка отсутствия влияния клиентов друг на друга

Запуск интеграционных тестов:

```bash
python -m pytest tests/integration
```

Запуск всех тестов с подробным выводом:

```bash
python -m pytest -v
```

### Тесты безопасности и надежности

Специальные тесты проверяют устойчивость системы к ошибкам, утечкам памяти и корректность работы при предельных нагрузках:

- **Тест очистки ресурсов** - проверка отсутствия утечки памяти и остаточных процессов при многократном создании и удалении сессий
- **Тест восстановления после ошибок** - проверка корректного восстановления системы после ошибок обработки данных неправильного размера
- **Тест одновременной работы** - проверка работы с несколькими параллельными клиентами
- **Тест graceful shutdown** - проверка корректного завершения при получении сигналов остановки
- **Тест таймаутов сессий** - проверка автоматического закрытия неактивных сессий

Запуск тестов безопасности:

```bash
python -m pytest tests/security/test_reliability.py -v
```

Запуск только конкретных тестов:

```bash
python -m pytest tests/security/test_reliability.py::test_resource_cleanup tests/security/test_reliability.py::test_multiple_clients -v
```

## Безопасность

- Валидация входных данных
- Защита от race conditions через механизм блокировок
- Автоматическая очистка ресурсов
- Graceful shutdown при получении сигналов завершения 